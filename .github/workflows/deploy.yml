name: Deploy Website to OSS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码（必须完整历史，turbo 才能 diff）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 安装 Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # 3. 安装 pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4. 安装依赖
      - name: Install dependencies
        run: pnpm install

      # 5. 只构建受影响的 apps，并输出 affected 列表
      - name: Turbo build (affected only)
        run: |
          BASE_SHA=${{ github.event.before }}

          echo "Base SHA: $BASE_SHA"
          echo "Current SHA: $GITHUB_SHA"

          pnpm turbo run build \
           --filter=...[$BASE_SHA] \
           --dry=json > affected.json

          cat affected.json

          # 真正执行 build
          pnpm turbo run build --filter=...[$BASE_SHA]
      # 6. 安装 qshell
      - name: Install qiniu cli
        run: |
          wget https://github.com/qiniu/qshell/releases/download/v2.9.0/qshell-v2.9.0-linux-amd64.tar.gz
          tar -zxvf qshell-v2.9.0-linux-amd64.tar.gz
          chmod +x qshell
          sudo mv qshell /usr/local/bin/qshell
          qshell -v

      # 7. 配置七牛账号
      - name: Configure Qiniu
        run: |
          qshell account \
            ${{ secrets.QINIU_ACCESS_KEY }} \
            ${{ secrets.QINIU_SECRET_KEY }} \
            qiniu-oss

      # 8. 只上传受影响 apps（先清空目录）
      - name: Upload affected apps to Qiniu OSS
        run: |
            rm -f refresh.txt

            if ! jq -e '.tasks and (.tasks | length > 0)' affected.json > /dev/null; then
            echo "No affected build tasks, skip upload"
            exit 0
            fi

            DIRS=$(jq -r '.tasks[].directory' affected.json | sort -u)

            for dir in $DIRS; do
            name=$(basename "$dir")
            dist="$dir/dist"

            if [ ! -d "$dist" ]; then
                echo "Skip $name, no dist directory"
                continue
            fi

            if [ "$name" = "home" ]; then
                echo "Clear OSS root and upload home"
                qshell rmr "${{ secrets.QINIU_BUCKET }}" ""

                qshell qupload2 \
                --src-dir="$dist" \
                --bucket="${{ secrets.QINIU_BUCKET }}" \
                --overwrite

                echo "https://${{ secrets.QINIU_CDN_DOMAIN }}/" >> refresh.txt
            else
                echo "Clear /$name and upload"
                qshell rmr "${{ secrets.QINIU_BUCKET }}" "$name"

                qshell qupload2 \
                --src-dir="$dist" \
                --bucket="${{ secrets.QINIU_BUCKET }}" \
                --key-prefix="$name/" \
                --overwrite

                echo "https://${{ secrets.QINIU_CDN_DOMAIN }}/$name/" >> refresh.txt
            fi
            done

            if [ -f refresh.txt ]; then
            echo "CDN refresh list:"
            cat refresh.txt
            fi

      # 9. 刷新 CDN 缓存
      - name: Refresh Qiniu CDN
        run: |
          if [ -s refresh.txt ]; then
            qshell cdnrefresh -i refresh.txt
          else
            echo "No CDN refresh needed"
          fi
