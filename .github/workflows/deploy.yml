name: Deploy Website to OSS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 拉取代码
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. 安装 Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # 3. 安装 pnpm
      - name: Install pnpm
        run: npm install -g pnpm

      # 4. 安装依赖
      - name: Install dependencies
        run: pnpm install

      # 5. 只 build 有变更的 app
      - name: Turbo build changed apps
        run: |
          pnpm turbo run build --filter=...[origin/main]

      # 6. 找出本次 build 的 app
      - name: Collect changed apps
        id: changed
        run: |
          pnpm turbo run build --filter=...[origin/main] --dry=json \
          | jq -r '.packages[]' > changed-apps.txt

          echo "changed=$(paste -sd, changed-apps.txt)" >> $GITHUB_OUTPUT

      # 7. 安装七牛 CLI
      - name: Install qiniu cli
        run: |
          wget https://kodo-toolbox-new.qiniu.com/qshell-v2.17.0-linux-amd64.tar.gz
          tar -zxvf qshell-v2.17.0-linux-amd64.tar.gz
          chmod +x qshell
          sudo mv qshell /usr/local/bin/qshell

      # 8. 配置七牛
      - name: Configure Qiniu
        run: |
          qshell account ${{ secrets.QINIU_ACCESS_KEY }} ${{ secrets.QINIU_SECRET_KEY }}

      # 9. 上传到 OSS（只上传变更的 app）
      - name: Upload changed apps to Qiniu OSS
        run: |
          for app in $(cat changed-apps.txt); do
            name=$(basename $app)
            dist="$app/dist"

            if [ ! -d "$dist" ]; then
              echo "Skip $name, no dist"
              continue
            fi

            if [ "$name" = "home" ]; then
              echo "Upload home to root"
              qshell qupload2 --src-dir=$dist --bucket=${{ secrets.QINIU_BUCKET }} --overwrite
            else
              echo "Upload $name to /$name"
              qshell qupload2 --src-dir=$dist --bucket=${{ secrets.QINIU_BUCKET }} --key-prefix="$name/" --overwrite
            fi
          done

      # 10. 刷新 CDN 缓存
      - name: Refresh Qiniu CDN
        run: |
          for app in $(cat changed-apps.txt); do
            name=$(basename $app)
            if [ "$name" = "home" ]; then
              qshell cdnrefresh --dirs https://${{ secrets.QINIU_CDN_DOMAIN }}/
            else
              qshell cdnrefresh --dirs https://${{ secrets.QINIU_CDN_DOMAIN }}/$name/
            fi
          done
    
    
    
